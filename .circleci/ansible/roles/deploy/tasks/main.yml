---
- name: "update apt packages."
  become: yes
  apt: 
    update_cache: yes
- name: "upgrade packages"
  become: yes
  apt: 
    upgrade: yes
- name: "install depdencies."
  become: true
  apt: 
    name: ["nodejs","npm","tar"]
    state: latest
    update_cache: yes
- name: "open the server."
  become: yes
  shell: |
    curl -sL https://deb.nodesource.com/setup_13.x | sudo -E bash -
- name: "open the server2."
  become: yes
  shell: |
    sudo apt-get install -y nodejs
- name: "create directory"
  file:
    path: /home/ubuntu/backend
    state: directory

- name: "copy backend folder"
  become: true
  copy: 
    src: /root/project/artifact.tar.gz
    dest: /home/ubuntu/backend/artifact.tar.gz

- name:
  shell: |
    cd /home/ubuntu/backend
    tar xvzf artifact.tar.gz -C .
    ls -la
- name: "install node dependencies"
  shell: |
    cd /home/ubuntu/backend
    npm install
    npm install -only=dev
- name: "building backend service"
  shell: |
   cd /home/ubuntu/backend
   npm run build
   npm run prestart:prod
- name: "running backend service"
  shell: |
    cd /home/ubuntu/backend
    pm2 start npm --no-automation --name "backend" --run start   

